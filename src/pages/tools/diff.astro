---
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
---

<Layout title="Diff Viewer - Roberto Salas" description="Compare two texts">
  <main class="min-h-screen">
    <Header lang="es" currentPage="/tools" />

    <div class="relative pt-24 pb-12 px-4">
      <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-6">
          <a href="/tools" class="inline-flex items-center gap-1.5 text-xs text-[var(--color-text-muted)] hover:text-[#7cb872] transition-colors mb-2">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            Tools
          </a>
          <h1 class="text-2xl font-semibold">Diff Viewer</h1>
        </div>

        <!-- Input Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium">Original</label>
              <span class="text-xs text-[var(--color-text-muted)]" id="lines-a">0 lines</span>
            </div>
            <textarea id="text-a" rows="14" spellcheck="false" placeholder="Paste original text here..." class="w-full px-4 py-3 bg-[var(--color-bg-alt)] border border-[var(--color-border)] rounded-lg text-sm font-mono focus:outline-none focus:border-[#7cb872] resize-none"></textarea>
          </div>
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium">Modified</label>
              <span class="text-xs text-[var(--color-text-muted)]" id="lines-b">0 lines</span>
            </div>
            <textarea id="text-b" rows="14" spellcheck="false" placeholder="Paste modified text here..." class="w-full px-4 py-3 bg-[var(--color-bg-alt)] border border-[var(--color-border)] rounded-lg text-sm font-mono focus:outline-none focus:border-[#7cb872] resize-none"></textarea>
          </div>
        </div>

        <!-- Controls -->
        <div class="flex flex-wrap items-center gap-3 mb-6">
          <button id="compare-btn" class="px-6 py-2.5 bg-[#7cb872] text-black font-medium rounded-lg hover:bg-[#6aa862] transition-colors">
            Compare
          </button>

          <select id="view-mode" class="px-3 py-2 bg-[var(--color-bg-alt)] border border-[var(--color-border)] rounded-lg text-sm focus:outline-none focus:border-[#7cb872]">
            <option value="side-by-side">Side by Side</option>
            <option value="line-by-line">Unified</option>
          </select>

          <label class="flex items-center gap-2 text-sm cursor-pointer select-none">
            <input type="checkbox" id="show-files" class="w-4 h-4 accent-[#7cb872]">
            <span>Show file header</span>
          </label>

          <div class="flex-1"></div>

          <button id="swap-btn" class="px-3 py-2 text-sm border border-[var(--color-border)] rounded-lg hover:border-[#7cb872] transition-colors">
            Swap
          </button>

          <button id="clear-btn" class="px-3 py-2 text-sm border border-[var(--color-border)] rounded-lg hover:border-[#7cb872] transition-colors">
            Clear
          </button>
        </div>

        <!-- Results -->
        <div id="diff-output"></div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-16">
          <div class="w-16 h-16 mx-auto mb-4 rounded-xl bg-[var(--color-bg-alt)] flex items-center justify-center">
            <svg class="w-8 h-8 text-[var(--color-text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <p class="text-[var(--color-text-muted)] mb-2">Paste two texts and click <strong class="text-[#7cb872]">Compare</strong></p>
          <p class="text-xs text-[var(--color-text-muted)]">
            <kbd class="px-1.5 py-0.5 bg-[var(--color-bg-alt)] border border-[var(--color-border)] rounded">Ctrl</kbd> +
            <kbd class="px-1.5 py-0.5 bg-[var(--color-bg-alt)] border border-[var(--color-border)] rounded">Enter</kbd>
          </p>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  @import "diff2html/bundles/css/diff2html.min.css";

  /* Override diff2html styles for dark mode */
  :global(.d2h-wrapper) {
    font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Monaco, Consolas, monospace !important;
    font-size: 13px !important;
  }

  :global(.d2h-file-wrapper) {
    border: 1px solid var(--color-border) !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    margin-bottom: 1rem !important;
  }

  :global(.d2h-file-header) {
    background: var(--color-bg-alt) !important;
    border-bottom: 1px solid var(--color-border) !important;
    padding: 10px 16px !important;
  }

  :global(.d2h-file-name-wrapper) {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  :global(.d2h-file-name) {
    color: var(--color-text) !important;
    font-weight: 500 !important;
  }

  :global(.d2h-file-stats) {
    display: flex !important;
    gap: 8px !important;
  }

  :global(.d2h-file-stats-wrapper) {
    display: none !important;
  }

  :global(.d2h-lines-added) {
    color: #22c55e !important;
    border: none !important;
    background: transparent !important;
  }

  :global(.d2h-lines-deleted) {
    color: #ef4444 !important;
    border: none !important;
    background: transparent !important;
  }

  :global(.d2h-diff-table) {
    font-family: inherit !important;
  }

  :global(.d2h-diff-tbody tr) {
    background: var(--color-bg) !important;
  }

  :global(.d2h-code-line-ctn) {
    background: var(--color-bg) !important;
    color: var(--color-text) !important;
    padding: 0 12px !important;
  }

  :global(.d2h-code-linenumber) {
    background: var(--color-bg-alt) !important;
    color: var(--color-text-muted) !important;
    border-right: 1px solid var(--color-border) !important;
    width: 50px !important;
    padding: 0 8px !important;
    text-align: right !important;
  }

  :global(.d2h-code-side-linenumber) {
    background: var(--color-bg-alt) !important;
    color: var(--color-text-muted) !important;
    border-right: 1px solid var(--color-border) !important;
  }

  /* Insertions - Green */
  :global(.d2h-ins) {
    background: rgba(34, 197, 94, 0.15) !important;
  }

  :global(.d2h-ins .d2h-code-line-ctn) {
    background: rgba(34, 197, 94, 0.15) !important;
  }

  :global(.d2h-ins .d2h-code-linenumber),
  :global(.d2h-ins .d2h-code-side-linenumber) {
    background: rgba(34, 197, 94, 0.25) !important;
    color: #22c55e !important;
    border-color: rgba(34, 197, 94, 0.3) !important;
  }

  :global(.d2h-ins.d2h-change) {
    background: rgba(34, 197, 94, 0.15) !important;
  }

  :global(ins.d2h-change) {
    background: rgba(34, 197, 94, 0.4) !important;
    text-decoration: none !important;
  }

  /* Deletions - Red */
  :global(.d2h-del) {
    background: rgba(239, 68, 68, 0.15) !important;
  }

  :global(.d2h-del .d2h-code-line-ctn) {
    background: rgba(239, 68, 68, 0.15) !important;
  }

  :global(.d2h-del .d2h-code-linenumber),
  :global(.d2h-del .d2h-code-side-linenumber) {
    background: rgba(239, 68, 68, 0.25) !important;
    color: #ef4444 !important;
    border-color: rgba(239, 68, 68, 0.3) !important;
  }

  :global(.d2h-del.d2h-change) {
    background: rgba(239, 68, 68, 0.15) !important;
  }

  :global(del.d2h-change) {
    background: rgba(239, 68, 68, 0.4) !important;
    text-decoration: none !important;
  }

  /* Info lines */
  :global(.d2h-info) {
    background: var(--color-bg-alt) !important;
    color: var(--color-text-muted) !important;
    border-color: var(--color-border) !important;
  }

  :global(.d2h-info .d2h-code-line-ctn) {
    background: var(--color-bg-alt) !important;
  }

  /* Side by side specific */
  :global(.d2h-file-side-diff) {
    width: 50% !important;
  }

  :global(.d2h-files-diff) {
    display: flex !important;
  }

  :global(.d2h-file-diff) {
    overflow-x: auto !important;
  }

  :global(.d2h-code-line) {
    padding: 2px 0 !important;
  }

  :global(.d2h-code-line-prefix) {
    width: 20px !important;
    padding: 0 4px !important;
    display: inline-block !important;
    user-select: none !important;
  }

  /* Empty cells */
  :global(.d2h-emptyplaceholder) {
    background: var(--color-bg-alt) !important;
  }

  /* Hide the tag icon */
  :global(.d2h-tag) {
    display: none !important;
  }

  :global(.d2h-file-diff .d2h-diff-table) {
    border-collapse: collapse !important;
  }

  :global(.d2h-diff-table tr:hover td) {
    background: inherit !important;
  }
</style>

<script>
  import { createTwoFilesPatch } from 'diff';
  import { html as diff2html } from 'diff2html';

  const textA = document.getElementById('text-a') as HTMLTextAreaElement;
  const textB = document.getElementById('text-b') as HTMLTextAreaElement;
  const linesA = document.getElementById('lines-a') as HTMLSpanElement;
  const linesB = document.getElementById('lines-b') as HTMLSpanElement;
  const diffOutput = document.getElementById('diff-output') as HTMLDivElement;
  const emptyState = document.getElementById('empty-state') as HTMLDivElement;
  const viewMode = document.getElementById('view-mode') as HTMLSelectElement;
  const showFiles = document.getElementById('show-files') as HTMLInputElement;

  // Update line counts
  function updateLineCounts() {
    const aLines = textA.value ? textA.value.split('\n').length : 0;
    const bLines = textB.value ? textB.value.split('\n').length : 0;
    linesA.textContent = `${aLines} line${aLines !== 1 ? 's' : ''}`;
    linesB.textContent = `${bLines} line${bLines !== 1 ? 's' : ''}`;
  }

  textA.addEventListener('input', updateLineCounts);
  textB.addEventListener('input', updateLineCounts);

  function compare() {
    const oldText = textA.value;
    const newText = textB.value;

    if (!oldText && !newText) {
      diffOutput.innerHTML = '';
      emptyState.classList.remove('hidden');
      return;
    }

    // Create unified diff
    const patch = createTwoFilesPatch(
      'Original',
      'Modified',
      oldText,
      newText,
      '',
      '',
      { context: 3 }
    );

    // Generate HTML
    const diffHtml = diff2html(patch, {
      drawFileList: false,
      matching: 'lines',
      outputFormat: viewMode.value as 'side-by-side' | 'line-by-line',
      renderNothingWhenEmpty: false,
    });

    diffOutput.innerHTML = diffHtml;
    emptyState.classList.add('hidden');

    // Hide file headers if option unchecked
    if (!showFiles.checked) {
      document.querySelectorAll('.d2h-file-header').forEach(el => {
        (el as HTMLElement).style.display = 'none';
      });
    }
  }

  // Event listeners
  document.getElementById('compare-btn')?.addEventListener('click', compare);

  viewMode.addEventListener('change', () => {
    if (diffOutput.innerHTML) compare();
  });

  showFiles.addEventListener('change', () => {
    if (diffOutput.innerHTML) compare();
  });

  document.getElementById('swap-btn')?.addEventListener('click', () => {
    const temp = textA.value;
    textA.value = textB.value;
    textB.value = temp;
    updateLineCounts();
    if (diffOutput.innerHTML) compare();
  });

  document.getElementById('clear-btn')?.addEventListener('click', () => {
    textA.value = '';
    textB.value = '';
    updateLineCounts();
    diffOutput.innerHTML = '';
    emptyState.classList.remove('hidden');
  });

  // Keyboard shortcut
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'Enter') {
      e.preventDefault();
      compare();
    }
  });

  // Init
  updateLineCounts();
</script>
